<html lang="en">
 {% include head.html %}
 
 <body ontouchstart="">
     {% include nav.html %}
     {% include search.html %}
 
     <!-- æ§åˆ¶èœå•ç»“æ„ä¿æŒä¸å˜ -->
 
     <div id="control-menu">
         <button id="menu-toggle" class="control-button">â˜°</button>
         <div id="menu-content">           
             <div id="announcement-toggle" title="å…¬å‘Šé€šçŸ¥" class="control-button">ğŸ“¢</div>
             <div id="dark-mode-toggle" title="æ·±è‰²æ¨¡å¼" class="control-button">ğŸŒ™</div>
             <div id="music-control" title="éŸ³ä¹æ’­æ”¾" class="control-button">
                 <iframe id="music-player" frameborder="no" border="0" marginwidth="0" marginheight="0" width="0" height="0"
                     src="//music.163.com/outchain/player?type=2&id=730861&auto=1&height=66"></iframe>
                 <span id="music-icon">â™«</span>
             </div>
             <div id="petals-toggle" title="å¼€å¯/å…³é—­èŠ±ç“£é£˜è½" class="control-button">ğŸ‚</div>
         </div>
     </div>
 
     <!-- å…¬å‘Šå¼¹çª— -->
     <div id="announcement-modal" class="modal">
         <div class="modal-content">
             <span class="close-modal">&times;</span>
             <div id="announcement-content">
                 <!-- Markdownå†…å®¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
             </div>
         </div>
     </div>
 
     {{ content }}
     {% include footer.html %}
 
     <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
 
     <script>
      document.addEventListener("DOMContentLoaded", function () {
     // DOMå…ƒç´ å¼•ç”¨
     const menuToggle = document.getElementById("menu-toggle");
     const menuContent = document.getElementById("menu-content");
     const darkModeToggle = document.getElementById("dark-mode-toggle");
     const musicControl = document.getElementById("music-control");
     const musicPlayer = document.getElementById("music-player");
     const musicIcon = document.getElementById("music-icon");
     const announcementToggle = document.getElementById("announcement-toggle");
     const announcementModal = document.getElementById("announcement-modal");
     const closeModal = document.querySelector(".close-modal");
     const announcementContent = document.getElementById("announcement-content");
     const petalsToggle = document.getElementById("petals-toggle");
 
     // çŠ¶æ€å˜é‡
     let isMenuOpen = localStorage.getItem("menu-open") === "true";
     let darkMode = localStorage.getItem("dark-mode");
     let isMusicExpanded = localStorage.getItem("music-expanded") !== "false";
     let petalsEnabled = localStorage.getItem("petals-enabled") === "true";
 
     // åˆå§‹åŒ–å‡½æ•°
     function init() {
         updateMenuState();
         applyDarkMode(darkMode === "true");
         initMusicPlayer();
         if (petalsEnabled) startPetals();
     }
 
     // èœå•æ§åˆ¶
     function updateMenuState() {
         if (isMenuOpen) {
             menuContent.style.opacity = "1";
             menuContent.style.visibility = "visible";
             menuContent.style.transform = "translateY(-1px)";
             menuToggle.textContent = "âœ•";
         } else {
             menuContent.style.opacity = "0";
             menuContent.style.visibility = "hidden";
             menuContent.style.transform = "translateY(0)";
             menuToggle.textContent = "â˜°";
         }
     }
 
     menuToggle.addEventListener("click", function (e) {
         e.stopPropagation();
         isMenuOpen = !isMenuOpen;
         localStorage.setItem("menu-open", isMenuOpen);
         updateMenuState();
     });
 
     // æ·±è‰²æ¨¡å¼
     function applyDarkMode(state) {
         document.body.classList.toggle("dark-mode", state);
         darkModeToggle.textContent = state ? "â˜€ï¸" : "ğŸŒ™";
         localStorage.setItem("dark-mode", state);
     }
 
     darkModeToggle.addEventListener("click", function (e) {
         e.stopPropagation();
         darkMode = darkMode === "true" ? "false" : "true";
         applyDarkMode(darkMode === "true");
     });
 
     // éŸ³ä¹æ§åˆ¶
     function initMusicPlayer() {
         musicPlayer.style.width = isMusicExpanded ? "280px" : "0";
         musicPlayer.style.height = isMusicExpanded ? "86px" : "0";
         musicPlayer.style.position = "fixed";
         musicPlayer.style.right = "80px";
         musicPlayer.style.bottom = "20px";
         musicPlayer.style.transition = "all 0.3s ease";
     }
 
     musicControl.addEventListener("click", function (e) {
         e.stopPropagation();
         isMusicExpanded = !isMusicExpanded;
         localStorage.setItem("music-expanded", isMusicExpanded);
         musicPlayer.style.width = isMusicExpanded ? "280px" : "0";
         musicPlayer.style.height = isMusicExpanded ? "86px" : "0";
     });
 
     // å…¬å‘ŠåŠŸèƒ½
     announcementToggle.addEventListener("click", function(e) {
         e.stopPropagation();
         loadAnnouncement();
     });
 
     function loadAnnouncement() {
         const announcementUrl = "{{ site.url }}{{ site.baseurl }}{{ site.announcement_path }}?t=" + Date.now();
         fetch(announcementUrl)
             .then(response => {
                 if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 return response.text();
             })
             .then(text => {
                 const content = text.replace(/^---[\s\S]*?---/, '').trim();
                 announcementContent.innerHTML = 
                     content ? marked.parse(content) : '<p class="no-content">æš‚æ— å…¬å‘Š</p>';
                 announcementModal.style.display = "block";
                 document.body.style.overflow = "hidden";
             })
             .catch(error => {
                 announcementContent.innerHTML = `
                     <div class="alert-error">
                         <strong>âš ï¸ åŠ è½½å¤±è´¥</strong>
                         <p>${error.message}</p>
                     </div>
                 `;
                 announcementModal.style.display = "block";
             });
     }
 
     closeModal.addEventListener("click", function() {
         announcementModal.style.display = "none";
         document.body.style.overflow = "auto";
     });
 
     window.addEventListener("click", function(event) {
         if (event.target === announcementModal) {
             announcementModal.style.display = "none";
             document.body.style.overflow = "auto";
         }
     });
 
     // èŠ±ç“£æ•ˆæœ
     function togglePetalsEffect() {
         petalsEnabled = !petalsEnabled;
         localStorage.setItem("petals-enabled", petalsEnabled);
         petalsEnabled ? startPetals() : stopPetals();
     }
 
     petalsToggle.addEventListener("click", function (e) {
         e.stopPropagation();
         togglePetalsEffect();
     });
 
     function startPetals() {
         stopPetals(); // å…ˆæ¸…é™¤ç°æœ‰èŠ±ç“£
 
         const container = document.createElement('div');
         container.className = 'falling-petals';
         document.body.appendChild(container);
 
         for (let i = 0; i < 20; i++) {
             const petal = document.createElement('div');
             petal.className = 'petal';
             petal.style.cssText = `
                 animation-duration: ${Math.random() * 5 + 4}s;
                 animation-delay: ${Math.random() * 5}s;
                 left: ${Math.random() * 100}vw;
                 ${document.body.classList.contains('dark-mode') ? 
                     'background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' : 
                     'background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)'}
             `;
             container.appendChild(petal);
         }
     }
 
     function stopPetals() {
         const existing = document.querySelector('.falling-petals');
         if (existing) existing.remove();
     }
     function togglePetalsEffect() {
         petalsEnabled = !petalsEnabled;
         localStorage.setItem("petals-enabled", petalsEnabled);
         petalsEnabled ? startPetals() : stopPetals();
     }
 
     petalsToggle.addEventListener("click", function (e) {
         e.stopPropagation();
         togglePetalsEffect();
     });
 
     function startPetals() {
         stopPetals(); // å…ˆæ¸…é™¤ç°æœ‰èŠ±ç“£
 
         const container = document.createElement('div');
         container.className = 'falling-petals';
         document.body.appendChild(container);
 
         for (let i = 0; i < 20; i++) {
             const petal = document.createElement('div');
             petal.className = 'petal';
             petal.style.cssText = `
                 animation-duration: ${Math.random() * 5 + 4}s;
                 animation-delay: ${Math.random() * 5}s;
                 left: ${Math.random() * 100}vw;
                 ${document.body.classList.contains('dark-mode') ? 
                     'background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' : 
                     'background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)'}
             `;
             container.appendChild(petal);
         }
     }
 
     function stopPetals() {
         const existing = document.querySelector('.falling-petals');
         if (existing) existing.remove();
     }
 
     // å“åº”å¼è°ƒæ•´
     function handleResize() {
         if (window.innerWidth <= 768) {
             musicPlayer.style.right = "60px";
             musicPlayer.style.bottom = "15px";
         } else {
             musicPlayer.style.right = "80px";
             musicPlayer.style.bottom = "20px";
         }
     }
 
     window.addEventListener('resize', debounce(handleResize, 200));
     handleResize();
 
     // å·¥å…·å‡½æ•°
     function debounce(func, wait) {
         let timeout;
         return function () {
             clearTimeout(timeout);
             timeout = setTimeout(func, wait);
         };
     }
 
     // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
     init();
 });
 
     </script>
     <link rel="stylesheet" href="{{ '/css/control-menu.css' | relative_url }}">
 </body>
 </html>
