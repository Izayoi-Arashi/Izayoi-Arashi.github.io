<!-- Navigation -->
{% if page.nav-style == "invert" or page.header-style == "text" %}
<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    {% else %}
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        {% endif %}
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="{{ site.baseurl }}/">{{ site.title }}</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="{{ site.baseurl }}/">Home</a>
                        </li>
                        {% for page in site.pages %}
                        {% if page.title and page.hide-in-nav != true %}
                        <li>
                            <a href="{{ page.url | prepend: site.baseurl }}">{{ page.title }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>

                        <!-- New control menu buttons -->
                        <li>
                            <button id="menu-toggle" class="control-button">☰</button>
                        </li>
                        <li>
                            <div id="announcement-toggle" title="公告通知" class="control-button">📢</div>
                        </li>
                        <li>
                            <div id="dark-mode-toggle" title="深色模式" class="control-button">🌙</div>
                        </li>
                        <li>
                            <div id="music-control" title="音乐播放" class="control-button">
                                <iframe id="music-player" frameborder="no" border="0" marginwidth="0" marginheight="0" width="0" height="0"
                                    src="//music.163.com/outchain/player?type=2&id=730861&auto=1&height=66"></iframe>
                                <span id="music-icon">♫</span>
                            </div>
                        </li>
                        <li>
                            <div id="petals-toggle" title="开启/关闭花瓣飘落" class="control-button">🍂</div>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Menu toggle and other functionalities here (same as before)

        document.addEventListener("DOMContentLoaded", function () {
            // DOM元素引用
            const menuToggle = document.getElementById("menu-toggle");
            const menuContent = document.getElementById("menu-content");
            const darkModeToggle = document.getElementById("dark-mode-toggle");
            const musicControl = document.getElementById("music-control");
            const musicPlayer = document.getElementById("music-player");
            const musicIcon = document.getElementById("music-icon");
            const announcementToggle = document.getElementById("announcement-toggle");
            const announcementModal = document.getElementById("announcement-modal");
            const closeModal = document.querySelector(".close-modal");
            const announcementContent = document.getElementById("announcement-content");
            const petalsToggle = document.getElementById("petals-toggle");

            // 状态变量
            let isMenuOpen = localStorage.getItem("menu-open") === "true";
            let darkMode = localStorage.getItem("dark-mode");
            let isMusicExpanded = localStorage.getItem("music-expanded") !== "false";
            let petalsEnabled = localStorage.getItem("petals-enabled") === "true";

            // 初始化函数
            function init() {
                updateMenuState();
                applyDarkMode(darkMode === "true");
                initMusicPlayer();
                if (petalsEnabled) startPetals();
            }

            // 菜单控制
            function updateMenuState() {
                if (isMenuOpen) {
                    menuContent.style.opacity = "1";
                    menuContent.style.visibility = "visible";
                    menuContent.style.transform = "translateY(-1px)";
                    menuToggle.textContent = "✕";
                } else {
                    menuContent.style.opacity = "0";
                    menuContent.style.visibility = "hidden";
                    menuContent.style.transform = "translateY(0)";
                    menuToggle.textContent = "☰";
                }
            }

            menuToggle.addEventListener("click", function (e) {
                e.stopPropagation();
                isMenuOpen = !isMenuOpen;
                localStorage.setItem("menu-open", isMenuOpen);
                updateMenuState();
            });

            // 深色模式
            function applyDarkMode(state) {
                document.body.classList.toggle("dark-mode", state);
                darkModeToggle.textContent = state ? "☀️" : "🌙";
                localStorage.setItem("dark-mode", state);
            }

            darkModeToggle.addEventListener("click", function (e) {
                e.stopPropagation();
                darkMode = darkMode === "true" ? "false" : "true";
                applyDarkMode(darkMode === "true");
            });

            // 音乐控制
            function initMusicPlayer() {
                musicPlayer.style.width = isMusicExpanded ? "280px" : "0";
                musicPlayer.style.height = isMusicExpanded ? "86px" : "0";
                musicPlayer.style.position = "fixed";
                musicPlayer.style.right = "80px";
                musicPlayer.style.bottom = "20px";
                musicPlayer.style.transition = "all 0.3s ease";
            }

            musicControl.addEventListener("click", function (e) {
                e.stopPropagation();
                isMusicExpanded = !isMusicExpanded;
                localStorage.setItem("music-expanded", isMusicExpanded);
                musicPlayer.style.width = isMusicExpanded ? "280px" : "0";
                musicPlayer.style.height = isMusicExpanded ? "86px" : "0";
            });

            // 公告功能
            announcementToggle.addEventListener("click", function(e) {
                e.stopPropagation();
                loadAnnouncement();
            });

            function loadAnnouncement() {
                const announcementUrl = "{{ site.url }}{{ site.baseurl }}{{ site.announcement_path }}?t=" + Date.now();
                fetch(announcementUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.text();
                    })
                    .then(text => {
                        const content = text.replace(/^---[\s\S]*?---/, '').trim();
                        announcementContent.innerHTML = 
                            content ? marked.parse(content) : '<p class="no-content">暂无公告</p>';
                        announcementModal.style.display = "block";
                        document.body.style.overflow = "hidden";
                    })
                    .catch(error => {
                        announcementContent.innerHTML = `
                            <div class="alert-error">
                                <strong>⚠️ 加载失败</strong>
                                <p>${error.message}</p>
                            </div>
                        `;
                        announcementModal.style.display = "block";
                    });
            }

            closeModal.addEventListener("click", function() {
                announcementModal.style.display = "none";
                document.body.style.overflow = "auto";
            });

            window.addEventListener("click", function(event) {
                if (event.target === announcementModal) {
                    announcementModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }
            });

            // 花瓣效果
            function togglePetalsEffect() {
                petalsEnabled = !petalsEnabled;
                localStorage.setItem("petals-enabled", petalsEnabled);
                petalsEnabled ? startPetals() : stopPetals();
            }

            petalsToggle.addEventListener("click", function (e) {
                e.stopPropagation();
                togglePetalsEffect();
            });

            function startPetals() {
                stopPetals(); // 先清除现有花瓣

                const container = document.createElement('div');
                container.className = 'falling-petals';
                document.body.appendChild(container);

                for (let i = 0; i < 20; i++) {
                    const petal = document.createElement('div');
                    petal.className = 'petal';
                    petal.style.cssText = `
                        animation-duration: ${Math.random() * 5 + 4}s;
                        animation-delay: ${Math.random() * 5}s;
                        left: ${Math.random() * 100}vw;
                        ${document.body.classList.contains('dark-mode') ? 
                            'background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' : 
                            'background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)'}
                    `;
                    container.appendChild(petal);
                }
            }

            function stopPetals() {
                const existing = document.querySelector('.falling-petals');
                if (existing) existing.remove();
            }

            // 初始化所有功能
            init();
        });
    </script>
</nav>
